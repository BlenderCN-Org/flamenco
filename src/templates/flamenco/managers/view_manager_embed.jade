.flamenco-box.manager
	form#item_form(onsubmit="return editManager()")
		| {% if can_edit %}
		.input-group
			textarea.item-name.input-transparent(
				name="name",
				type="text",
				rows=1,
				placeholder="Manager's name") {{ manager.name | hide_none }}
			button.copy-to-clipboard.btn.item-id(
				style="margin-left: auto",
				name="Copy to Clipboard",
				type="button",
				data-clipboard-text="{{ manager._id }}",
				title="Copy ID to clipboard")
				| ID
		.input-group
			textarea.item-description.input-transparent(
				name="description",
				type="text",
				rows=1,
				placeholder="Manager's description") {{ manager.description | hide_none }}

		.input-group
			button#item-save.btn.btn-default.btn-block(type='submit')
				i.pi-check
				| Save Manager
		| {% else %}
		p.item-name {{ manager.name | hide_none }}
		| {% if manager.description %}
		p.item-description {{ manager.description | hide_none }}
		| {% endif %}
		| {% endif %}

.flamenco-box.manager
	h4 Properties
	.table.item-properties
		.table-body
			.table-row.properties-last-updated
				.table-cell Last Updated
				.table-cell(title='Unable to edit, set by Manager')
					| {{ manager._updated | hide_none | pretty_date_time }}
			.table-row.properties-url
				.table-cell URL
				.table-cell(title='Unable to edit, set by Manager')
					| {% if manager.url %}
					a(href="{{ manager.url }}") {{ manager.url }}
					| {% else %}
					| None yet, will be set by the Manager
					| {% endif %}

	| {% if manager.variables %}
	h4 Variables
	.table.item-properties
		.table-body(title='Unable to edit, set by Manager')
			| {% for var_key, var_values in manager.variables.to_dict().items()  %}
			.table-row.properties-variables
				.table-cell
					| {{ var_key }}
				.table-cell
					pre.
						{{ var_values | pprint}}
			| {% endfor %}
	| {% endif %}

.flamenco-box.manager#manager-projects-list
	h4 Projects linked to this Manager

	.table.item-properties
		.table-body
			| {% for project in linked_projects._items %}
			.table-row.properties-url
				.table-cell
					i.pi-blender-cloud
				.table-cell
					a(href="{{ url_for('flamenco.jobs.perproject.index', project_url=project.url) }}")
						| {{ project.name }}
				.table-cell
					a(href='javascript:unlinkProject("{{ project._id }}")')
						i.pi-trash
			| {% endfor %}

	.pull-right
		| {% if available_projects %}
		select#link_project_select
			| {% for project in available_projects %}
			option(value="{{ project._id }}") {{ project.name }}
			| {% endfor %}
		button.btn.btn-success(onclick="linkProject()")
			i.pi-link
			| Link project
		| {% elif linked_projects %}
		button.btn.btn-default(disabled)
			| All available projects are linked already.
		| {% else %}
		button.btn.btn-default(disabled)
			| You have no projects set up for Flamenco.
		| {% endif %}
	.clearfix
	.action-result-panel

#item-view-feed
	| {% if config.DEBUG %}
	.debug-info
		a.debug-info-toggle(role='button',
			data-toggle='collapse',
			href='#debug-content-manager',
			aria-expanded='false',
			aria-controls='debug-content-manager')
			i.pi-info
			| Debug Info
		#debug-content-manager.collapse
			pre.
				{{ manager.to_dict() | pprint }}
	| {% endif %}

| {% block footer_scripts %}
script.
	var clipboard = new Clipboard('.copy-to-clipboard');

	clipboard.on('success', function(e) {
		statusBarSet('info', 'Copied manager ID to clipboard', 'pi-check');
	});

	function unlinkProject(project_id) {
		console.log("Unlinking project ", project_id, " from Manager ", "{{ manager._id }}")
		patchManager({
			op: 'remove-from-project',
			project: project_id,
		})
		.fail(function(err) {
			var $p = xhrErrorResponseElement(err, 'Error unlinking project: ');
			$('.action-result-panel').html($p);
		})
		;
	}

	function linkProject() {
		var project_id = $('#link_project_select').val();
		patchManager({
			op: 'assign-to-project',
			project: project_id,
		})
		.fail(function(err) {
			var $p = xhrErrorResponseElement(err, 'Error linking project: ');
			$('.action-result-panel').html($p);
		})
		;
	}

	function editManager() {
		var $form = $('#item_form');
		patchManager({
			op: 'edit-from-web',
			name: $form.find('*[name="name"]').val(),
			description: $form.find('*[name="description"]').val(),
		})
		.fail(function(err) {
			var $p = xhrErrorResponseElement(err, 'Error editing Manager: ');
			$('.action-result-panel').html($p);
		})
		;

		return false;
	}
	
	function patchManager(patch) {
		var promise = $.ajax({
			url: '/api/flamenco/managers/{{ manager._id }}',
			method: 'PATCH',
			contentType: 'application/json',
			data: JSON.stringify(patch),
		})
		.done(function() {
			item_open('{{ manager._id }}', 'manager', false);
		})
		.fail(function(err) {
			console.log('Error patching: ', err);
		})
		;
		
		return promise;
	}
	
| {% endblock %}
